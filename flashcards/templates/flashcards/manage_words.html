{% extends "base.html" %}

{% block title %} - Manage Words{% endblock %}

{% block content %}
    <!-- Heading for the manage words page -->
    <h1>Manage Words</h1>
    <div>
        <!-- Form for creating a word -->
        <h4>Create New Word</h4>
        <form method="post" action="{% url 'flashcards:manage_words' %}">
            {% csrf_token %}

            <div style="display: flex; align-content: space-around">
                <label for="word">Word:</label>
                <input type="text" name="word" id="create-word" required
                       style="height: 25px; margin-left: 10px; margin-right: 10px; padding-bottom: 5px;">
                <input type="hidden" name="warning" id="warning" value="{{ form.warning.value }}">
                <div class="alert-container" id="word-alert" style="height: 25px; display: flex; align-items: center;">
                    {% if messages %}
                        <ul class="messages">
                            {% for message in messages %}
                                <li{% if message.tags %}
                                    class="custom-alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}

                </div>
            </div>

            <br>
            <div style="display: flex; align-content: center">
                <label for="definition">Definition:</label>
                <textarea name="definition" id="create-definition" required
                          style="height: 50px; margin-left: 10px"></textarea>
            </div>


            <br>
            <input type="submit" value="Create Word" class="btn btn-primary">

        </form>
    </div>
    <div style="display: flex; justify-content: flex-start">

    <div>
        <!-- List of existing words -->
        <h4>Existing Words</h4>
        <ul id="word-list" style="padding-left: 0; margin-top: 0;">
            {% for word in words %}
                <div>
                    <li data-id="{{ word.id }}" data-word="{{ word.word }}" data-definition="{{ word.definition }}"
                        style="display: flex; align-items: center;">
                        <a href="javascript:void(0)" class="word-link">{{ word.id }}: {{ word.word }}
                            - {{ word.definition }}</a>
                        <form method="post" action="{% url 'flashcards:delete_word' word.id %}" class="delete-form"
                              style="margin-left: -5px;">
                            {% csrf_token %}
                            <button class="delete-button" type="submit">
                                <i class="fa-regular fa-circle-xmark"></i>
                            </button>
                        </form>
                    </li>
                </div>
            {% endfor %}
        </ul>
    </div>

    <div style="margin-left: 10px">
        <!-- Form for updating a word (hidden by default) -->
        <h4 id="update-heading" style="display: none;">Update Word</h4>
        {% if word and word.id %}
            <form method="post" action="{% url 'flashcards:manage_words_with_id' word.id %}"
                  id="update-form" style="display: none;">
        {% else %}
            <form method="post" action="{% url 'flashcards:manage_words' %}" id="update-form"
                  style="display: none;">
        {% endif %}
        {% csrf_token %}
        <input type="hidden" name="word_id" id="update-word-id">
        <div style="display: flex; align-content: space-around">
            <label id="id-label">ID: {{ word.id }}</label>
        </div>
        <div style="display: flex; align-content: space-around">
            <label for="word">Word:</label>
            <input type="text" name="word" id="update-word" required
                   style="height: 25px; margin-left: 10px; margin-right: 10px; padding-bottom: 5px;">
        </div>
        <br>
        <div style="display: flex; align-content: center">
            <label for="definition">Definition:</label>
            <textarea name="definition" id="update-definition" required
                      style="height: 50px; margin-left: 10px"></textarea>
        </div>
        <br>
        <input type="submit" value="Update Word" class="btn btn-primary">
        </form>

    </div>
{% endblock %}

{% block javascript %}
    <script>
        // Get all delete forms
        const deleteForms = document.querySelectorAll('.delete-form');

        // Add an event listener to each form
        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                // Prevent the form from submitting
                event.preventDefault();

                // Confirm with the user
                const confirmDelete = confirm('Are you sure you want to delete this word? This action cannot be undone.');

                // If the user confirmed, submit the form
                if (confirmDelete) {
                    form.submit();
                }
            });
        });

        // Get all word links
        const wordLinks = document.querySelectorAll('.word-link');

        // Add an event listener to each word link
        wordLinks.forEach(link => {
            link.addEventListener('click', function (event) {
                // Prevent the link from navigating
                event.preventDefault();

                // Get the parent li element
                const li = event.target.closest('li');

                // Get the word ID from the data-id attribute of the li element
                const wordId = li.dataset.id;

                document.getElementById('update-word-id').value = wordId;

                // Update the ID label text
                document.getElementById('id-label').textContent = `ID: ${wordId}`;

                // Update the action URL of the update form
                document.querySelector('#update-form').action = `{% url 'flashcards:manage_words' %}`.replace('0', wordId);

                // Update the update form fields with the word data from the li element
                document.querySelector('#update-word').value = li.dataset.word;
                document.querySelector('#update-definition').value = li.dataset.definition;

                // Show the update form
                document.querySelector('#update-heading').style.display = 'block';
                document.querySelector('#update-form').style.display = 'block';
            });
        });

        // todo: make this work
        // Get the create word input field
        const createWordInput = document.querySelector('#create-word');

        // Add an event listener for the keyup event
        createWordInput.addEventListener('keyup', debounce(function (event) {
            // Get the current value of the input field
            const word = event.target.value;

            // Make an AJAX call to check if the word already exists
            fetch(`{% url 'flashcards:check_word' %}?word=\${word}`)
                .then(response => response.json())
                .then(data => {
                    // Update the input field value with the response
                    createWordInput.value = data.exists ? '' : word;

                    // Get the alert container
                    const alertContainer = document.querySelector('#word-alert');

                    // Remove any existing alerts
                    alertContainer.innerHTML = '';

                    // If the word already exists, show an alert
                    if (data.exists) {
                        const alert = document.createElement('div');
                        alert.classList.add('alert', 'alert-warning', 'custom-alert');
                        alert.setAttribute('role', 'alert');
                        alert.textContent = 'This word already exists.';
                        alertContainer.appendChild(alert);
                    }
                });


        }, 300))

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                const later = function () {
                    timeout = null;
                    func.apply(context, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }


    </script>
{% endblock %}

